backported all recent changes from 1.20